---
- name: üîí CIS Hardening Compliance Check and Enforcement
  hosts: linux_servers
  become: true
  vars:
    # --- Vari√°veis de Configura√ß√£o CIS ---
    # Defina o n√≠vel de compliance CIS desejado.
    # Exemplo: '1', '2' (Lembrando que o N√≠vel 2 √© mais restritivo e pode quebrar aplica√ß√µes)
    cis_level: 1

    # Defina o perfil do SO (adapte o nome da vari√°vel conforme a role usada)
    cis_profile: "server" 

    # Se a sua role suportar, use 'True' para apenas verificar (check mode)
    # ou 'False' para aplicar as corre√ß√µes.
    # cis_check_only: False 
    
    # Lista de regras para excluir, se necess√°rio (exemplo)
    # cis_skip_list: 
    #   - rule_1_1_22 # Exclui a regra espec√≠fica 
  
  pre_tasks:
    - name: ‚öôÔ∏è Check OS Family for Role Compatibility
      ansible.builtin.assert:
        that:
          - ansible_os_family in ['RedHat', 'Debian']
        fail_msg: "This role only supports RedHat (RHEL/CentOS) or Debian-based systems."
        
  roles:
    # Nota: Substitua 'ansible-lockdown.cis-hardening' pela role espec√≠fica que voc√™ instalou.
    - role: ansible-lockdown.cis-hardening
      vars:
        # Passa as vari√°veis definidas acima para a role
        level: "{{ cis_level }}"
        profile: "{{ cis_profile }}"
        # check_only: "{{ cis_check_only }}"

  post_tasks:
    - name: ‚ö†Ô∏è Inform user if a reboot is needed
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required
      when: ansible_os_family == 'Debian'

    - name: ‚ö†Ô∏è Inform user if a reboot is needed (RedHat-based)
      ansible.builtin.command: needs-restarting -r
      register: needs_restarting_rhel
      ignore_errors: true # O comando falha se n√£o precisar de reboot
      changed_when: false
      when: ansible_os_family == 'RedHat'

    - name: üö® REBOOT REQUIRED: Please schedule a maintenance window
      ansible.builtin.debug:
        msg: "The system has installed packages requiring a reboot. Please schedule a controlled reboot immediately."
      when: 
        - (ansible_os_family == 'Debian' and reboot_required.stat.exists) 
        - (ansible_os_family == 'RedHat' and needs_restarting_rhel.rc == 1)
